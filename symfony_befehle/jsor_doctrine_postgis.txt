Symfony
==
composer require jsor/doctrine-postgis

Setup
--

To use the library with the Doctrine ORM (version 2.9 or higher is supported),
register a [Doctrine event subscriber](https://symfony.com/doc/current/doctrine/event_listeners_subscribers.html)
in `config/services.yml`.

```yaml
services:
    Jsor\Doctrine\PostGIS\Event\ORMSchemaEventSubscriber:
        tags:
            - { name: doctrine.event_subscriber, connection: default }
```

The library can also be used with DBAL only (versions 2.13 or higher and 3.1 or
higher are supported).

```yaml
services:
    Jsor\Doctrine\PostGIS\Event\DBALSchemaEventSubscriber:
        tags:
            - { name: doctrine.event_subscriber, connection: default }
```

### Database Types

It is also recommended registering the DBAL types in the
[doctrine section](https://symfony.com/doc/current/reference/configuration/doctrine.html)
of the `config/packages/doctrine.yaml` config file.

```yaml
doctrine:
    dbal:
        types:
            geography:
                class: 'Jsor\Doctrine\PostGIS\Types\GeographyType'
                commented: false
            geometry:
                class: 'Jsor\Doctrine\PostGIS\Types\GeometryType'
                commented: false
			raster:
                class: 'Jsor\Doctrine\PostGIS\Types\RasterType'
                commented: false
```

### DQL Functions

To use the DQL functions provided by this library, they must be configured in
`config/packages/doctrine.yaml`.

```yaml
doctrine:
    orm:
        dql:
            string_functions:
				ST_Contains: Jsor\Doctrine\PostGIS\Functions\ST_Contains
				ST_GeomFromText: Jsor\Doctrine\PostGIS\Functions\ST_GeomFromText
				ST_Within: Jsor\Doctrine\PostGIS\Functions\ST_Within
				# ...other string functions
				numeric_functions:
				ST_Distance: Jsor\Doctrine\PostGIS\Functions\ST_Distance
				# ...other numeric functions
```

Known Problems
--

### PostGIS Schema Exclusion

Since PostGIS can add a few new schemas, like `topology`, `tiger` and
`tiger_data`, you might want to exclude them from being handled by Doctrine,
especially when you use the [Doctrine Migrations Bundle](https://www.doctrine-project.org/projects/doctrine-migrations-bundle.html).

This can be done by configuring the `schema_filter` option in
`config/packages/doctrine.yaml`.

```yaml
doctrine:
    dbal:
        schema_filter: ~^(?!tiger)(?!topology)~
```

See also [Manual Tables](https://symfony.com/doc/current/bundles/DoctrineMigrationsBundle/index.html#manual-tables)
in the Symfony documentation.

### Unknown Database Types

Sometimes, the schema tool stumbles upon database types it can't handle.
A common exception is something like

```
Doctrine\DBAL\Exception: Unknown database type _text requested, Doctrine\DBAL\Platforms\PostgreSQL100Platform may not support it.
```

To solve this, the unknown database types can be mapped to known types with the
`mapping_types` option in `config/packages/doctrine.yaml`.

```yaml
doctrine:
    dbal:
        mapping_types:
            _text: string
```


Example
	use Doctrine\ORM\Mapping as ORM;
	use Jsor\Doctrine\PostGIS\Types\PostGISType;

	#[ORM\Entity]
	class MyEntity
	{
		#[ORM\Column(
			type: PostGISType::GEOMETRY, 
			options: ['geometry_type' => 'POINT'],
		)]
		public string $point;

		#[ORM\Column(
			type: PostGISType::GEOMETRY, 
			options: ['geometry_type' => 'POINTZM'],
	   )]
		public string $point4D;

		#[ORM\Column(
			type: PostGISType::GEOMETRY, 
			options: ['geometry_type' => 'POINT', 'srid' => 3785],
		)]
		public string $pointWithSRID;

		public function __construct(
			string $point,
			string $point4D,
			string $pointWithSRID,
		) {
			$this->point = $point;
			$this->point4D = $point4D;
			$this->pointWithSRID = $pointWithSRID;
		}
	}


**Note:** This type is then not suited to be used in entity mappings.
It just prevents "Unknown database type..." exceptions thrown during database
inspections by the schema tool.

If you want to use this type in your entities, you have to configure real
database types, e.g. with the [PostgreSQL for Doctrine](https://github.com/martin-georgiev/postgresql-for-doctrine)
package.